Patch Plan Consolidated (Stage-1 ~ Stage-3)

Toonflow-app-2 前后端整合 Patch Plan（A1 路径，src/web 合并 Toonflow-web，src/electron/main.js 热重载初步实现）

版本: 1.0 范围: READ-ONLY 文档；不修改代码、配置或执行命令。以下文本为 Stage-1、Stage-2、Stage-3 的合并版执行蓝图，后续落地请以此为分阶段补丁清单参考。

一、阶段目标与范围

Stage-1 Patch Plan（最小可运行版本，纯文本）

目标与范围
结构目标
A1：将 Toonflow-web 的源码直接合并到 src/web，成为前端统一入口。
Electron 主进程入口放置在 src/electron/main.js，具备热重载的开发友好特性（初步思路：electronmon + electron-reload）。
根目录通过 Yarn Workspaces 管理 ["src/web", "src/electron"]，未来可扩展为完整的 monorepo。
开发运行流
dev:web：启动 Toonflow-web 的前端开发服务器，端口固定为 5173，沿用现有前端构建工具（Vite/Webpack/CRA）。
dev:gui：启动 Electron，加载本地开发服务器地址 http://localhost:5173；入口为 src/electron/main.js。
如需要并发启动，计划使用并发工具（如 concurrently），在根目录集中管理。
API 与环境变量
根级提供统一的本地开发 API_BASE_URL，通过 .env.development.template + .env.local 实现覆盖。
实现阶段划分
阶段 1：基础框架与最小可运行版本，确认结构、端口、入口定位、环境变量入口。
阶段 2：对齐与稳定性（跨包依赖、路径、tsconfig、并发启动日志等）。
阶段 3：生产打包与文档（生产打包、上线准备、开发文档）。
Stage-1 可执行清单（阶段性骨架，纯文本） A. 目标结构与文件位置
src/web
直接包含 Toonflow-web 的前端源码，作为前端入口根目录。
要点：确保现有 Toonflow-web 的入口点（index.html、前端入口文件）在合并后仍然可识别与启动；如需，保留一个清晰的入口层级以便后续调整。
src/electron
main.js：Electron 主进程入口文件的骨架，包含热重载初步实现思路（如 electronmon + electron-reload）的设计要点。
preload.js（如需要）：供渲染进程访问的桥接脚本。
package.json：Electron 相关依赖与 dev 脚本（静态/开发模式分离策略待定）。
根目录
package.json：启用 Yarn Workspaces，最小结构为 ["src/web", "src/electron"]，并保留 dev:web、dev:gui 的骨架脚本位置留给后续实现。
.yarnrc.yml：若采用 Yarn 3.x，添加基础配置（hoist、工作区策略等）。
.env.development.template：开发环境变量模板，包含 API_BASE_URL 的示例。
tsconfig.json：全局初步配置，确保跨包路径映射与编译的基础支持。
B. 启动脚本设计（阶段性骨架）

dev:web
目标：启动 Toonflow-web 的前端开发服务器，端口 5173。
方式：保留现有 Toonflow-web 的命令路径，端口 5173 的固定使用。如果现有工具没有统一 dev 脚本，阶段性骨架中留一个可替换的 dev:web 启动点。
dev:gui
目标：启动 Electron，加载 http://localhost:5173，入口定位为 src/electron/main.js。
方式：根级命令触发 Electron 启动，热重载初步实现（如 electronmon + electron-reload）。
并发启动
初步方案：在根目录引入并发工具（如 concurrently），实现 dev:web 与 dev:gui 的并发启动。Stage-1 以骨架形式保留，后续在 Stage-2/Stage-3 中落地具体实现。
端口
前端端口固定为 5173，阶段 1 内保持不变。
C. 热重载实现要点（阶段性）

Electron 主进程热重载
初步思路：引入 electronmon 用于主进程热重载，监视 src/electron/ 及 main.js 的变动，变动时自动重启。
额外备选：使用 electron-reload 对主进程相关文件进行监控并触发重启。
渲染进程热重载
依赖前端构建工具原生的热更新能力；
Electron 通过加载 http://localhost:5173 实现渲染进程的热更新体验。
启动组合
dev:gui 启动 Electron，dev:web 启动前端服务器。并发启动方案在 Stage-2/Stage-3 中进一步明确实现。
D. API_BASE_URL 与环境变量

读取与覆盖
根级提供 .env.development.template，包含 API_BASE_URL 的示例值。
.env.local（或其他覆盖文件）实现本地开发环境的灵活切换。
前后端统一从 process.env.API_BASE_URL 读取地址，Electron 与 Web 客户端保持一致性。
字段设计
维持简单字段设计，不引入额外字段细化（如 API_VERSION、前缀等）。
E. 验收与回滚

验收要点
本地能同时启动 dev:web 与 dev:gui，Electron 窗口加载前端，前端能访问本地后端 API。
回滚点
阶段 1 结束时若出现不可解决的问题，可回滚到不修改前端入口的状态，阶段 2 再尝试并继续推进。
风险与缓解
依赖冲突、路径/类型错位、版本兼容性、热重载稳定性等，将在 Stage-2 继续解决。
Stage-2 Patch Plan（对齐与稳定性）

Stage-2 目标与范围
目标
完成 Workspaces 的稳定性、依赖冲突解决、路径对齐、并发启动的落地实现。
细化 dev:web 与 dev:gui 的实际启动脚本，确保在根目录可稳定启动。
固化 TypeScript 路径别名与 tsconfig，确保跨包编译无错。
完善环境变量的覆盖机制，确保 Stage-1 的 .env.development.template 与 .env.local 的刷新与切换无缝工作。
验收标准
Stage-2 完成后，Workspaces 正常工作、依赖冲突最小化、启动日志清晰、并发启动稳定。
Stage-2 关键工作项
Workspaces 与依赖
在根 package.json 中正式配置 "workspaces": ["src/web", "src/electron"]，并确保 yarn.lock 的一致性。
对现有 Toonflow-web 依赖与根部依赖进行对齐，避免版本冲突（如 React、TypeScript、vite 等的版本统一）。
如需要，调整根级的 hoisting 策略，确保边界清晰。
启动脚本与并发
实现 dev:web 的实际命令（基于 Toonflow-web 的当前工具链，如 vite 或等效命令）。
实现 dev:gui 的实际命令，使用 electronmon 和/或 electron-reload 的组合来实现主进程热重载。
引入并发启动工具（如 concurrently），在根目录提供一个可执行命令同时启动 dev:web 与 dev:gui。
路径与 TS 配置
统一根 tsconfig 与 src/web 的 tsconfig 设置，确保 paths、baseUrl、typeRoots 等配置不冲突。
API_BASE_URL 及环境变量
实现根级的环境变量覆盖策略，确保在 Electron 与 Web 客户端均能读取到统一的 API_BASE_URL。
提供一个简单的环境变量说明文档，便于团队使用。
日志与调试
增设开发阶段的日志输出规范，区分热重载触发、正常启动、API 请求的日志。
验收与回滚
验收标准：阶段 2 结束时，开发工作流稳定，端口不冲突，路径对齐无错误。
回滚策略：如遇冲突，回滚到 Stage-1 的骨架实现，逐步推进。
Stage-3 Patch Plan（生产化与文档）

Stage-3 目标
生产打包与文档闭环
完成生产打包与开发文档的闭环。
将 Electron 与 Web 的生产打包分离，提供清晰的本地开发与生产环境的切换指引。
提供完整的对外文档（API_BASE_URL 的使用、端口配置、环境变量、部署步骤、回滚策略、测试用例）。
生产打包
Electron 打包配置 production 构建，生成桌面安装包。
Web 打包：生成生产版本输出，支持在 Electron 中嵌入或独立部署。
文档
提供本地开发指南、环境变量说明、端口配置、以及生产打包步骤的完整文档。
Stage-3 验收标准
生产打包流程能够独立运行，生成可分发的 Electron 安装包及 Web 构建产物。
文档完整，团队成员能够按文档完成本地开发与打包执行。
九、附注

该文本为纯文本 Patch Plan 的 Stage-1、Stage-2、Stage-3 的合并输出，严格遵循只读原则。实际的补丁清单、代码变更、配置修改、命令执行等将在你授权后以补丁形式逐步提交执行。
如需，我可以在后续阶段继续输出 Stage-2/Stage-3 的正式文本版本，或将 Stage-1/Stage-2 的执行清单进一步拆分成更细粒度的子项文本。